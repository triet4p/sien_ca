workflows:
  ios_sien_ca_unsigned:
    name: Sien Ca iOS (Unsigned for Sideloadly)
    max_build_duration: 30
    instance_type: mac_mini_m2

    environment:
      flutter: stable
      xcode: latest
      cocoapods: default

    scripts:
      # ----------------------------------------------------------------
      # 1. SETUP & DEPENDENCIES
      # ----------------------------------------------------------------
      - name: Install dependencies & Generate Icons
        script: |
          #!/bin/bash
          set -e
          
          echo "üì¶ Running Flutter pub get..."
          flutter pub get
          
          # T·ª± ƒë·ªông t·∫°o Icon n·∫øu b·∫°n ƒë√£ config trong pubspec.yaml
          echo "üé® Generating App Icons..."
          flutter pub run flutter_launcher_icons || true

          echo "üîß Precaching iOS tools..."
          flutter precache --ios

      # ----------------------------------------------------------------
      # 2. HACK PROJECT (QUAN TR·ªåNG: G·ª° b·ªè y√™u c·∫ßu Signing)
      # ----------------------------------------------------------------
      - name: Disable Signing & Configure Xcode Project
        script: |
          #!/bin/bash
          set -e
          
          echo "üèóÔ∏è Generating Xcode project structure..."
          # Ch·∫°y l·ªánh build ·∫£o ƒë·ªÉ Flutter t·∫°o ra c√°c file Pods v√† xcodeproj
          flutter build ios --release --no-codesign || true
          
          PBXPROJ="ios/Runner.xcodeproj/project.pbxproj"
          
          if [ -f "$PBXPROJ" ]; then
              echo "üîí Hacking project.pbxproj to remove signing requirements..."
              cp "$PBXPROJ" "$PBXPROJ.backup"
              
              # D√πng l·ªánh sed ƒë·ªÉ x√≥a s·∫°ch c√°c d√≤ng y√™u c·∫ßu ch·ª©ng ch·ªâ trong file c·∫•u h√¨nh Xcode
              sed -i '' 's/CODE_SIGN_IDENTITY = .*;/CODE_SIGN_IDENTITY = "";/g' "$PBXPROJ"
              sed -i '' 's/DEVELOPMENT_TEAM = .*;/DEVELOPMENT_TEAM = "";/g' "$PBXPROJ"
              sed -i '' 's/ProvisioningStyle = Automatic;/ProvisioningStyle = Manual;/g' "$PBXPROJ"
              sed -i '' 's/ENABLE_BITCODE = YES;/ENABLE_BITCODE = NO;/g' "$PBXPROJ"
              
              echo "‚úÖ Code signing disabled successfully!"
          else
              echo "‚ùå Error: project.pbxproj not found!"
              exit 1
          fi

      # ----------------------------------------------------------------
      # 3. BUILD ARCHIVE (UNSIGNED)
      # ----------------------------------------------------------------
      - name: Build XCArchive via xcodebuild
        script: |
          #!/bin/bash
          set -e
          
          cd ios
          
          echo "üîÑ Updating Pods (Required for shared_preferences)..."
          pod repo update --silent
          pod install
          
          echo "üöÄ Building Runner.xcarchive..."
          # Build native v·ªõi c·ªù c·∫•m Signing
          xcodebuild \
            -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            -archivePath ../build/Runner.xcarchive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            DEVELOPMENT_TEAM="" \
            ENABLE_BITCODE=NO \
            COMPILER_INDEX_STORE_ENABLE=NO \
            archive
          
          cd ..

      # ----------------------------------------------------------------
      # 4. PACKAGE IPA (MANUAL PAYLOAD)
      # ----------------------------------------------------------------
      - name: Package Payload into IPA
        script: |
          #!/bin/bash
          set -e
          
          APP_PATH="build/Runner.xcarchive/Products/Applications/Runner.app"
          
          if [ ! -d "$APP_PATH" ]; then
              echo "‚ùå Error: Runner.app not found. Build failed."
              exit 1
          fi
          
          echo "üì¶ Packaging IPA manually for Sideloadly..."
          cd build/Runner.xcarchive/Products/Applications
          
          # T·∫°o folder Payload chu·∫©n c·ªßa Apple
          mkdir -p Payload
          cp -r Runner.app Payload/
          
          # Zip l·∫°i th√†nh file .ipa
          # Flag -y quan tr·ªçng ƒë·ªÉ gi·ªØ Symlinks
          zip -r -y SienCa_Unsigned.ipa Payload/
          
          # Move ra ngo√†i ƒë·ªÉ Artifacts l·∫•y ƒë∆∞·ª£c
          mv SienCa_Unsigned.ipa ../../../../SienCa_Unsigned.ipa
          
          echo "üéâ IPA Created: SienCa_Unsigned.ipa"

    # ----------------------------------------------------------------
    # 5. OUTPUT
    # ----------------------------------------------------------------
    artifacts:
      - SienCa_Unsigned.ipa